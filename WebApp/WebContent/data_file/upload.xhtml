<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	template="/WEB-INF/templates/basic_page.xhtml">

	<ui:define name="title">Upload Files</ui:define>
	<ui:define name="localHead">
		<h:outputScript name="script/dataFiles.js"/>
		<h:outputStylesheet name="style/dataFiles.css"/>
	</ui:define>
	
	<ui:define name="pageTitle">#{fileUpload.currentInstrument.name} - Upload Data Files</ui:define>

	<ui:define name="content">
		<h:form id="uploadForm" method="post" charset="utf8">
			<div class="pageTable">
				<div id="uploadFile">
					<p:messages id="messages" autoUpdate="true" closable="true"/>
					<div id="messages" class="error listBox hidden"></div>
					<p:outputLabel value="Select a file to upload"/>
					<p:fileUpload fileUploadListener="#{fileUpload.handleFileUpload}"
					mode="advanced" auto="false" oncomplete="extractNext()"
					multiple="true" update="fileDetails" widgetVar="fileUploadWidget"/>
				</div>
				<p:outputPanel id="fileDetails" styleClass="#{fileUpload.displayClass}">
					<p:remoteCommand
					name="extractNext"
					action="#{fileUpload.extractNext()}"
					process="@this"
					update="fileList storeFileButton" />
					<p:dialog id="msgDialog" widgetVar="msgDialog" header="Errors and messages" minHeight="40" >
						<p:scrollPanel style="height:200px" mode="native">
							<div id="messageText"></div>
						</p:scrollPanel>>
					</p:dialog>
					<p:dataTable
					id="fileList"
					var="file"
					value="#{fileUpload.uploadedFiles}"
					rowStyleClass="#{file.messageClass}"
					rowIndexVar="rowIndex"
					>
					    <p:column headerText="Filename">
					        <h:outputText value="#{file.name}" />
					    </p:column>
					    <p:column headerText="Start date">
					        <h:outputText escape="false"
							value="#{file.startDate}" >
							    <f:convertDateTime pattern="#{fileUpload.longDateFormat}" />
							</h:outputText>
							<div class="tablespinner #{file.startDate == null and file.messageClass == '' ? 'loading' : ''}"></div>
					    </p:column>

					    <p:column headerText="End date">
					        <h:outputText escape="false"
							value="#{file.endDate}" >
							    <f:convertDateTime pattern="#{fileUpload.longDateFormat}" />
							</h:outputText>
							<div class="tablespinner #{file.endDate == null and file.messageClass == '' ? 'loading' : ''}"></div>
					    </p:column>

					    <p:column headerText="No. of records">
					        <h:outputText value="#{file.rowCount}" />
					    </p:column>
					    <p:column headerText="Store file to database">
							<p:selectBooleanCheckbox
							id="fileStoreCheckbox"
							styleClass="#{file.endDate == null or file.messageClass != '' ? 'hidden' : 'ready'}"
							value="#{file.store}" />
							<p:commandButton
							id="messageButton"
							icon="fa-info-circle"
							styleClass="messageButton #{file.messageClass == '' ? 'hidden' : ''}"
							onclick="renderMessages($(this).data('messages'))"
							title="Errors"
							value="Errors"
							>
								<f:passThroughAttribute name="data-messages" value="#{file.messages}" />
							</p:commandButton>
						</p:column>
					</p:dataTable>
				</p:outputPanel>
			</div>
			<h:panelGrid columns="1" cellpadding="5" class="buttonPanel">
				<p:commandButton id="storeFileButton"
				styleClass="#{fileUpload.storeFileButtonClass}" icon="ui-icon-disk"
						title="Store marked files to database"
						value="Store marked files to database"
						actionListener="#{fileUpload.store()}"
						ajax="true" update="fileList"
						action="file_list"
						/>
				<p:button value="Back to File List" outcome="file_list"/>
			</h:panelGrid>
		</h:form>
	</ui:define>
</ui:composition>